---
- name: Check if database is already initialized
  stat:
    path: '/var/lib/postgresql/18/main/PG_VERSION'
  register: init_status
- name: Stop database if running
  systemd:
    state: stopped
    name: postgresql@18-main
  become_user: root
  when: init_status.stat.exists == False
- name: Initialize the master database
  shell: "pg_createcluster 18 main"
  when: init_status.stat.exists == False
  become_user: root
- name: Promote slave database to master
  shell: "/usr/lib/postgresql/18/bin/pg_ctl promote -D /var/lib/postgresql/18/main"
  when: init_status.stat.exists == True and standby_status.stat.exists == True
- name: Start database
  systemd:
    state: started
    name: postgresql@18-main
  become_user: root
- name: Create replication user, set MD5-hashed password, grant privs
  postgresql_user:
    name: "{{ repl_user }}"
    password: "{{ 'md5' + ((repl_passwd + repl_user) | hash('md5')) }}"
    role_attr_flags: REPLICATION
    priv: ALL
    db: postgres
- name: Configure DBs to listen on ip address
  postgresql_set:
    name: listen_addresses
    value: 'localhost,{{ ansible_host }}'
  notify: Restart database
- name: Configure wal_level parameter
  postgresql_set:
    name: wal_level
    value: 'replica'
- name: Configure wal_log_hints parameter
  postgresql_set:
    name: wal_log_hints
    value: 'on'
- name: Configure max_wal_senders parameter
  postgresql_set:
    name: max_wal_senders
    value: '8'
- name: Configure wal_keep_segments parameter
  postgresql_set:
    name: wal_keep_segments
    value: '8'
- name: Configure hot_standby parameter
  postgresql_set:
    name: hot_standby
    value: 'on'
- name: Enable replication user to login
  blockinfile:
    path: /etc/postgresql/18/main/pg_hba.conf
    block: |
      host    replication     {{ repl_user }}     0.0.0.0/0    trust
  notify: Restart database
